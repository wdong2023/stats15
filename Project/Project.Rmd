---
title: "Stats 15 Project"
author: "Team 13: Wanyue Dong, Michelle Pang, Liaohan Wang"
date: "10/31/2022"
output: pdf_document
---


# **Section 1 - Introduction**

## **1.1 - Motivating Questions and Scope of Analysis**

As one of the biggest cities in China, Beijing currently houses a population of 21.33 million residents. With the rapid rate of globalization, the movement of people selling and buying their property has risen as well. However, with the help of Lianjia, buyers and sellers are able to view and list properties with ease. In this project, we seek to answer the following motivating question: **what affects the price per square foot of a property?**

## **1.2 - Background on Lianjia**

***Basic Structure:*** Lianjia is a Chinese real-estate company that allows buyers and sellers to view and list properties all over China on the Lianjia website. In our data set, we narrowed down our listings to those that were traded in 2017 in the city of Beijing. This means that any property that was listed or sold in 2017 through Lianjia will be included in this dataset. We found our data set on a website called Kaggle which is a data science company which provides a variety of public data sets. Before cleaning the data, our data set had 318,851 listings and 26 variables.

***How a Seller can Post a Listing:*** To post a listing on Lianjia, the owner or the real estate agent of the property will have to follow the guidelines and steps provided by filling out the necessary information regarding the property such as price of listing, number of bathrooms, square footage of the entire property and more listed below in the explanatory variables. They will also need to provide accompanying photographs of the property.

***How a Buyer can Purchase a Listing:*** To purchase a listing on Lianjia, the buyer can simply just reach out to the contact number or email of the real estate angent provided to arrange a viewing. After viewing the property and possible negotiations, both parties will agree on a price for the transaction and legal paperwork will be organized by the real estate agency to facilitate the payment process and finally legalize the change of ownership of the property.


## **1.3 - Variable Explanation**

### **Explanatory Variables**

1. ***DOM***: (*numerical*) The active days on market. The number of days since the property is posted until it is sold and removed from the website. 
2. ***followers***: (*numerical*) The number of people who follow the transaction by bookmarking the property to revisit later on. This indicates the popularity of a property compared to the other listings.
3. ***livingRoom***: (*numerical*) The number of bedrooms.
4. ***drawingRoom***: (*numerical*) The number of living rooms.
5. ***kitchen***: (*numerical*) The number of kitchens.
6. ***bathRoom***: (*numerical*) The number of bathrooms.
7. ***floor***: (*numerical*) The total number of floors the building has. This usually also refers to the height of the building.
8. ***constructionTime***: (*categorical*) The year the building was constructed.
9. ***renovationCondition***: (*categorical*) The quality of the renovation with 4 being the best and 1 being the worst.
10. ***buildingStructure***: (*categorical*) The material that is used the most to construct the building. More specifically, the main material used to build the exterior of the building. In this case, 1 refers to the material being unknown, 2 refers to the material being a mix of more than 3 distinguishable materials, 3 refers to brick and wood, 4 refers to brick and concrete, 5 refers to steel and 6 refers to steel-concrete composite. 
11. ***ladderRatio***: (*categorical*) The proportion between the number of elevators or ladders that particular floor has to the number of households who live on the same floor. It describes how many ladders a household have on average. In this case, 0.5 means two households share 1 elevator/ladder. The higher the number, the more elevators or ladders a household can use. 
12. ***elevator***: (*categorical*) The presence of an elevator or not. In this case, 1 refers to the presence of an elevator in the building and 0 refers to the absence of an elevator in the building.
13. ***fiveYearsProperty***: (*categorical*) Refers to whether or not the previous owner has owned the property for less than five years. In this case, 1 refers to the property being owned by the previous owner for less than five years and 0 refers to the property being owned by the previous owner for more than five years. In Beijing, if a house/apartment has been owned for 5 years, the tax will be less than owning it for less than five years. 
14. ***subway***: (*categorical*) Based on the knowledge of the seller posting the listing, this variable shows if a subway is located near the property. In this case, 1 refers to the presence of a subway nearby and 0 refers to the absence of a subway nearby. Whether or not a property is near a subway is self reported by the seller.


```{r pressure, echo=FALSE, fig.cap="Beijing District Map", out.width = '50%'}
knitr::include_graphics("beijing_map.jpeg")
```

15. ***district***: (*categorical*) There are 13 main districts in Beijing and each number from 1 to 13 refers to a different district in which the property lies in. In this case, 1 refers to DongCheng, 2 refers to FengTai, 3 refers to YiZhuang (a sub-region of DaXing, we will consider it as DaXing in the following analysis), 4 refers to DaXing, 5 refers to FangShan, 6 refers to ChangPing, 7 refers to ChaoYang, 8 refers to HaiDian, 9 refers to ShiJingShan, 10 refers to XiCheng, 11 refers to TongZhou, 12 refers to MenTouGou, and 13 refers to ShunYi.

As shown in the map above, there are a total of 16 districts in Beijing, but we mainly focuses on the listed 12 districts which are shown on the map as yellow, red, and purple. Green districts are not included in this Lianjia dataset. Yellow and red parts are considered the core districts. In other words, "the city". They contains the main functions of Beijing in political, cultural and economic ways. The yellow parts, DongCheng and XiCheng contain the most history of the city. They have a relative small area but most ancient buildings preserved. Thus, there are actually not that much area could be used for residency nor new structures. Among these red parts, ChaoYang and HaiDian are a bit special. ChaoYang is the largest among the core districts. It has the majority of foreign embassies and it is also the business center. HaiDian is famous for education. It contains the most education institutions. Purple parts are considered suburb areas where airports are located. Green parts are excluded from our data because these are relative rural that are mostly made up of mountains, Great Walls, manors for travelers, etc.

### **Response Variable**
1. ***price***: (*integer*) The price per square foot of the property (price = totalPrice / square). To ensure that the price is a fair comparison across all the properties listed, we decided to compare the price per square foot of all properties instead of totalPrice. Since some properties may be bigger than others, comparing price per square foot provides us with a better understanding of how valuable a property is.



# Section 2: Data Cleaning
```{r, message=FALSE, warning=FALSE}
# loading libraries
library(lubridate)
library(dplyr)
library(VIM)
library(stringr)
library(ggplot2)
library(naniar)
library(waffle)
```

```{r}
# the following code is used to import dataset that includes Chinese character
data <- read.csv("new.csv", fileEncoding = "GBK", encoding = "GBK")
```


## 2.1 Cleaning Trade Time Variable
The `tradeTime` variable is in the format of y-m-d, we wanted to look at year, month, and day separately. Therefore, we created new variables `year`, `month`, `day` based on `tradeTime`. \newline
Since the current data has 318851 rows, we decided to use part of the data where the trade time was in 2017.

```{r, message=FALSE, warning=FALSE}
data2017 <- data %>% 
  mutate(year = year(tradeTime), month = month.name[month(tradeTime)], day = day(tradeTime)) %>%
  filter(year == 2017)
```


## 2.2 Cleaning Floor Variable 

The `floor` variable two piece of information. The first part, which is in Chinese character, informs the floor range of the apartment/house. The second part, which is a number, tells us the total number of floors the building has. Therefore, we need to separate these two information into two new variables (` totalFloor` and `floorRange`) to better analyze them. At the same time, we converted Chinese characters into English. 

```{r, echo=FALSE}
data2017 <- data2017 %>% 
  mutate(totalFloor = as.numeric(str_extract(floor, "(\\d)+")), 
         floorRange = case_when(str_detect(floor, "顶") ~ "top", 
                                str_detect(floor, "高") ~ "high", 
                                str_detect(floor, "中") ~ "midium",
                                str_detect(floor, "低") ~ "low",
                                str_detect(floor, "底") ~ "bottom"))

```

## 2.3 Cleaning variable format

Some variables such as living room and bedroom  should be numerical variable, while other variables such as subway and elevator should be categorical variables. We also recoded the district variable into district names, which will be easier to see for later analysis. Moreover, the living room in this dataset should be bedroom and drawing room in this dataset should be living room. Finally, we recoded some categorical variables such as subway and elevator to have text in the values to see them clearly. 

```{r, warning=FALSE, message=FALSE}

data2017 <- data2017 %>% 
  rename(livingRoom = drawingRoom, bedRoom = livingRoom) %>%
  mutate(constructionTime = as.numeric(constructionTime), 
         livingRoom = as.numeric(livingRoom),
         bedRoom = as.numeric(bedRoom),
         bathRoom = as.numeric(bathRoom),
         kitchen = as.numeric(kitchen),
         subway = as.factor(subway),
         elevator = as.factor(elevator),
         fiveYearsProperty = as.factor(fiveYearsProperty),
         district = recode(district, "1" = "DongCheng",
                           "2" = "FengTai", "3" = "DaXing", "4" = "DaXing", 
                           "5" = "FangShan", "6" = "ChangPing", "7" = "ChaoYang",
                           "8" = "HaiDian", "9" = "ShiJingShan", "10" = "XiCheng", 
                           "11" = "TongZhou", "12" = "MenTouGou", "13" = "ShunYi"),
         subway = recode(subway, "0" = "not_near_subway", "1" = "near_subway"),
         elevator = recode(elevator, "0" = "no", "1" = "yes"),
         fiveYearsProperty = recode(fiveYearsProperty, "0" = "no", "1" = "yes"),
         renovationCondition = recode(renovationCondition, "1" = "other", "2" = "rough", 
                                      "3" = "simplicity", "4" = "hardcover"),
         buildingStructure = recode(buildingStructure, "1" = "other", "2" = "mixed", 
                                    "3" = "brick&wood", "4" = "brick&concrete", 
                                    "5" = "steel-concrete"))
```




## 2.4 Missing Values

```{r, message=FALSE, warning=FALSE}
table(is.na(data2017))
na_plot <- aggr(data2017, col=c('skyblue','red'), numbers=TRUE, sortVars=TRUE, 
                labels=names(data2017), cex.axis=.4, gap=3, ylab=c("Missing data","Pattern"))
```

Our data had 1303 missing values. All missing values are in variables construction time, building type, community average, and floor range. The above graph shows the proportion of missing values in each variable with the highest being 0.018 for construction time. \newline
We decided to remove all missing values for two reasons. First, 1303 missing values is a relatively small amount of data compared to 43217 observations we have. Second, we did not plan to use the variable buildingType and community average, which had a large portion of missing values. 

```{r}
data2017 <- na.omit(data2017)
```

Now we have 42710 observations.

## 2.5 Remove unnecessary variables

The final step of data cleaning is removing variables that we do not plan to use. 
```{r}
data2017 <- data2017 %>%
  select(-c(url, Lng, Lat, Cid, tradeTime, floor, buildingType, communityAverage, year))
```




# Section 3: Exploratory Analysis

## 3.1 Distribution of variables and outliers

### 3.1.1 Month
```{r}
ggplot(data2017, aes(x = month)) + 
  geom_bar(fill = "light blue") + 
  scale_x_discrete(limits = month.name)
```

The first three months of year 2017 had the most trading of houses, with March being the highest number of trading, more than 8000 tradings. Apirl, May, and June each only had less than 1/4 of the number of trading compared to March. The amount of transactions for the rest of the year remained below 4000. One possible explanation for this trend is that Chinese people like to buy houses in the beginning of the year as a way of starting a fresh year. 


### 3.1.2 Day
```{r}
ggplot(data2017, aes(x = day)) + 
  geom_histogram(fill = "light blue", color = "black", bins = 31)
quantile(data2017$day)
```
Number of transactions of a day is uniform. There isn't a unique day of the month that people liked to buy houses, but people relatively like to buy houses in the middle of the month. Few trades happened in the beginning of the month. Approximately 25% of the houses are sold on and before 10th. 50% of the houses are sold on or before 17th. 25% of the houses are sold on or after 24th. 


### 3.1.3 Total Floor
```{r}
ggplot(data2017, aes(x = totalFloor)) + geom_histogram(color = "black", fill = "blue") 
quantile(data2017$totalFloor, c(0, .025, .25, .5, .75, .975, 1))

data2017 %>% arrange(desc(totalFloor)) %>% select(id, totalFloor, floorRange) %>% head()
data2017 <- data2017 %>%
  filter(totalFloor < 60)
```
The distribution of total floor is unimodel and skewed to the right. The median number of floors is 6. 75% of the buildings less than or equal to 6 floors. Only 2.5% of the buildings had more than 18 floors. Some high numbers could be an error in data recording. The url for the apartment located in a building with 63 floors is invalid; however, we checked the apartment located in the building with 57 floors using url and, surprisingly, the building does exist and is called Yu Jin Tai. Therefore, we only removed the trade with total floor of 63. 



### 3.1.4 Floor Range
```{r}
summary_table <- data2017 %>% group_by(floorRange) %>%
  summarise(total = n()) %>%
  mutate(percent = round(100 * total / sum(total)))
counts <- summary_table$percent
names(counts) <- summary_table$floorRange
print(counts)
waffle(counts)
```
Apartments located in the middle of a building were traded the most in 2017. All the other floor range had roughly the same percentage. 



### 3.1.5 DOM
The graph of number of days on market is unimodal and heavily skewed to the right. The mean number of days on market is around 51 and the median is 31 days. Approximately 2.5% of values are below 2. Approximately 2.5% of values are above 196. The longest day on market is 721. Whereas there are total of 474 houses have less or equal to 1 day on market until sold. A great portion of these houses are sold in March, which is the peak of house transaction in Beijing in 2017 as the previous 'month' variable section showed. And most of these houses are located in ChaoYang(7) district. According to the following 'district' variable section showed, ChaoYang indeed is the district that has the most transactions. The number of followers of these houses is between 0 to 9, which is not a great number. And nearly half of these houses have no followers. It shows that the number of followers is not necessarily indicating the "popularity" of the houses.

```{r}
ggplot(data2017, aes(x=DOM))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("DOM")+ylab("Count")+ggtitle("Active Days on Market Histogram")

mean(data2017$DOM)
median(data2017$DOM)
quantile(data2017$DOM, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

data2017 %>%
  filter(DOM<=1) %>%
  nrow()  # number of houses have less than 1 day on market

data2017 %>%
  filter(DOM<=1) %>%
  count(month) # In which months are these houses sold

data2017 %>%
  filter(DOM<=1) %>%
  count(district) # In which districts are these houses sold

data2017 %>%
  filter(DOM<=1) %>%
  count(followers) # Do houses sold fast have many followers?
```

### 3.1.6 followers

The graph of number of followers is unimodal and heavily skewed to the right. The mean and median number of followers is the same, which is around 49 people. Approximately 2.5% of values are below or equal to 0. Approximately 2.5% of values are above 216. However, the highest 2.5% are between 216 and 1143, which suggests that there are a few significantly popular houses. There are 5617 houses with 0 follower. There are also a total of 5 houses with more than 1000 followers. Among these houses with more than 1000 followers, there is 1 house has significant low total price compare with other houses. However, it also has relative small area and is located in the suburb, which makes this reasonable. 

```{r}
ggplot(data2017, aes(x=followers))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("followers")+ylab("Count")+
  ggtitle("followers Histogram")

mean(data2017$followers)
quantile(data2017$followers, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

data2017 %>% filter(followers>1000)
```


### 3.1.7 totalPrice
## problem: some districts do not have high or low 2.5% houses and are not shown on the tibbles. So the numbers do not match. Replace missing values with 0?

The graph of total price is diamond-shaped, unimodal, and skews right. The average total price of a house in Beijing in 2017 is 526x10,000 yuan (around 750~810 thousands dollars depend on inflation) and the median is 460x10,000 yuan (around 660~710 thousands dollars). 
Approximately 2.5% of values are below 215x10,000 yuan. Among these houses, ChangPing(6) has significantly higher amounts of these. ChangPing is the northern suburb of Beijing. And the second one is ChaoYang(7).
Approximately  2.5% of values are above 1250x10,000 yuan. Among these houses, ChangPing(6) has none of these whereas ChaoYang(7) has significantly highest amounts of these. It seems like ChaoYang has houses with big ranges of prices. Even though XiCheng(10) and DongCheng(1) are the most central part of Beijing and close to each other, XiCheng has 85% more higher 2.5% percentile houses sold in 2017. XiCheng spans 32 square kilometers and DongCheng spans 40.6 square kilometers. DongCheng actually has larger area than XiCheng but XiCheng has more houses sold.


```{r}
ggplot(data2017, aes(x=totalPrice))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("totalPrice")+ylab("Count")+ggtitle("Total price (in 10,000yuan) Histogram")

mean(data2017$totalPrice)
quantile(data2017$totalPrice, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

# tried to compute percenatge of low&high 2.5% within each district to find out what affect DongCheng and XiCheng
lower2_5 <- data2017 %>%
  filter(totalPrice<=215) %>% 
  group_by(district) %>% # number of lower 2.5% houses in each district
  summarize(n()) #%>%
  #pull()
lower2_5

higher2_5 <- data2017 %>% # number of higher 2.5% houses in each district
  
  group_by(district) %>%
   filter(totalPrice>=1250) %>%
  summarise(n())
  #pull()
higher2_5

ggplot(data2017, aes(x=district,y=totalPrice))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

```


### 3.1.8 price

The graph for price is Diamond-shaped, unimodal, and skewed right. The average price per square meter is around 67,430 yuan and median is 62670, which are relative close. Approximately 2.5% of values are above 127,359 yuan. Approximately 2.5% of values are below 33,035 yuan. The house that has the lowest value has 136 yuan per square meter, which is about 20 dollars per square meter. Such low price doesn't make sense in any part of Beijing. Therefore, we decided to remove this outlier. 

```{r}
ggplot(data2017, aes(x=price))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("price")+ylab("Count")+ggtitle("Average price per square meter (in yuan) Histogram")

mean(data2017$price)
quantile(data2017$price, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

data2017 %>%
  filter(price<=1000) 

data2017 <- data2017 %>% 
  filter(price>1000)

summary(data2017$price)

ggplot(data2017, aes(x=district,y=price))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
```


### 3.1.9 square

The graph of number of squares is diamond-shaped, unimodal, and skews right. The mean of houses sold in Beijing in 2017 have around 73 square meters. The median is 63.85 square meters. Approximately 2.5% of values are below 38.6 square meters. Approximately 2.5% of values are above 150 square meters. 

```{r}
ggplot(data2017, aes(x=square))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("square")+ylab("Count")+ggtitle("square of the House Histogram") 

mean(data2017$square)
quantile(data2017$square, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))
```
A house with more 1745.5 square meter seems very unreasonable, so we decided houses that are less than 1000 square meters are plausible. 
```{r}
data2017 <- data2017 %>% 
  filter(square < 1000)
```

### 3.1.10 bedRoom

One thing need to be noticed is that in this dataset, the variable 'livingRoom' could be understand as 'bedroom' in the US. Thus, we decided t ochange the variable name from 'livingRoom' to 'bedRoom'. 
The graph of number of bedrooms is unimodal, diamond-shaped, and skews right. Most of the houses have 2 bedrooms, and the mean and median number of bedrooms is also 2. Approximately 25% of values are below or equal to 1. Approximately  2.5% of values are above 3. (continued)

```{r}
ggplot(data2017, aes(x=bedRoom))+
  geom_bar(fill='lightblue', color='black') + 
  xlab("bedRoom")+ylab("Count")+ggtitle("Number of bedroom Histogram")

mean(data2017$bedRoom)
quantile(data2017$bedRoom, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

# 1 house with 0 bed room
table(data2017$bedRoom)

data2017 %>%
  slice_max(bedRoom,n=1) 
  
data2017 %>%
  slice_min(bedRoom,n=1)
```

There is one house has 0 bedroom but sold in 145,612 yuan per square meter which almost reached the highest square per meter sold among all observations (150,000 yuan). Pulled out the link of this house, we found that it is located in XiCheng. According to Lianjia website, this house belongs to "RongFeng 2008" community. After a research on the community, we found out that this is the average price per square meter for this community. An investigation conducted by The Beijing News indicates that "RongFeng 2008" has a relative 10,000 yuan higher price per square meter compared with other communities in that area. But since the houses in this community have very small areas, the total price is still acceptable for most people who wanted to move to XiCheng. So this house is not an outlier.

(https://www.sohu.com/a/479132582_114988)

```{r}
data %>%
  filter(id=="101101275312")
```
### 3.1.11 livingRoom

The number of living rooms for all houses is between 0 to 4. Most houses sold in 2017 have 0 to 2 living rooms and nearly 78% of houses sold in 2017 have 1 living room. Houses with 0 living room is the third greatest choice, and it is reasonable for a house to have no living room, especially in the city.

```{r}
ggplot(data2017, aes(x=livingRoom))+
  geom_bar(fill='lightblue', color='black') + # use geom_bar() instead of geom_histogram()
  xlab("livingRoom")+
  ylab("Count")+
  ggtitle("Number of Living Rooms Histogram")

table(data2017$livingRoom)/length(data2017$livingRoom)
```


### 3.1.12 district 

```{r}
ggplot(data2017, aes(x=district))+
  geom_bar(fill='lightblue', color='black') +
  xlab("district")+
  ylab("Count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  ggtitle("District the House located Histogram") 

district_percentage <- data2017 %>%
  group_by(district) %>%
  count(district) %>%
  mutate(percentage=n*100/42004) %>% # what percentage of sold houses are in each district
  arrange(desc(n))
district_percentage

```

### 3.1.13 kitchen

```{r}
data2017 %>% 
  filter(kitchen > 2) 
```

There are two houses with more than 2 kitchens, which seem odd. Taking a closer look, both of these houses had less than 300 square meters, which is impossible to have 3 kitchens in fairly medium house size. Therefore, we removed these two outliers.

```{r}
data2017 <- data2017 %>%
  filter(kitchen < 3)
```

The distribution for the number of kitchens shows that most listings have only one kitchen in their property. However, having no kitchen is evidently more common than having 2 kitchens in a property.

``` {r}
ggplot(data2017, aes(x = kitchen)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Kitchen Summary") +
  xlab("Number of Kitchens") +
  ylab("Count")
```

### 3.1.14 bathroom

The distribution for the number of bathrooms shows that most listings have only one bathroom in their property. This distribution skews heavily to the right and the count decreases as number of bathrooms increases.

``` {r}
ggplot(data2017, aes(x = bathRoom)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Bathroom Summary") +
  xlab("Number of Bathrooms") +
  ylab("Count")
```

### 3.1.15 construction time

```{r}
table(data2017$constructionTime)
```

``` {r}
median(data2017$constructionTime)
mean(data2017$constructionTime)
```

The year of construction of the listings that were transacted in 2017 ranges from the year 1950 to the year 2016. Out of all the included listings, most of the properties were built in the year 2004 accumulating a total of 2525 properties.

The distribution skews to the left as the median of the year 2002 and mean of the year 1999 both lie to the left of the mode of the year 2004.

``` {r}
ggplot(data2017, aes(x = constructionTime)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Time of Construction Summary") +
  xlab("Time of Construction") +
  ylab("Count")
```

### 3.1.16 renovation condition

The condition of renovation 

The distribution for the condition of renovation shows that most listings have the highest score of 4 in terms of the condition of renovation for their listing. This distribution skews heavily to the left.

``` {r}
ggplot(data2017, aes(x = renovationCondition)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Condition of Renovation Summary") +
  xlab("Condition of Renovation") +
  ylab("Count")
```

### 3.1.17 building structure

The distribution for the building structure shows that most listings are made of steel-concrete composite. This distribution skews heavily to the left.

``` {r}
ggplot(data2017, aes(x = buildingStructure)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Structure of Building Summary") +
  xlab("Structure of Building") +
  ylab("Count")
```

### 3.1.18 ladder ratio

The maximum value for ladderRatio is 10009400, which seems like a typo, so we decided to remove this observation. 

``` {r}
data2017 <- data2017 %>% 
  filter(ladderRatio < 5)
```

```{r}
table(data2017$ladderRatio)
```

``` {r}
median(data2017$ladderRatio)
mean(data2017$ladderRatio)
```

The distribution for the ladder ratio shows that most listings have 2 residents to one elevator per floor. This distribution skews heavily to the left as the average number of residents sharing an elevator per floor is 3.

``` {r}
ggplot(data2017, aes(x = ladderRatio)) +
  geom_bar(fill = "lightblue", width = 0.05) +
  ggtitle("Ladder Ratio Summary") +
  xlab("Ladder Ratio") +
  ylab("Count")
```

### 3.1.19 elevator

The distribution for the presence of an elevator shows that it is more common for listings to have at lease one elevator in the building compared to none at all.

``` {r}
ggplot(data2017, aes(x = elevator)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Availability of Elevator") +
  xlab("Elevator") +
  ylab("Count")
```

### 3.1.20 five years property

The distribution for whether the previous has stayed in the listing for less than five years shows that most sellers stay in their property for less than five years.

``` {r}
ggplot(data2017, aes(x = fiveYearsProperty)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Five Years Property Summary") +
  xlab("Five Years Property") +
  ylab("Count")
```

### 3.1.21 subway

The distribution for the presence of any nearby subways shows that it is more common for listings to have at lease one subway nearby the building compared to none at all.

``` {r}
ggplot(data2017, aes(x = subway)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Subway Summary") +
  xlab("Availability of Nearby Subways") +
  ylab("Count")
```



## 3.2 Potential Relationships between Variables

### 3.2.1 DOM vs. followers

*Do houses sold fast have many followers?*
Among these 188 houses that were sold within 1 day, 140 have no follower and the maximum number of followers is 25, which is not a significant number of followers. But in general as shown on the graph, the graph is unimodal, diamond-shaped, and heavily skew right. Which indicates that the number of followers is decreasing as the number of days on market increase.

```{r}
table(data2017$DOM<=1) # number of 0 or 1 Days in market
data2017 %>%
  filter(DOM<=1) %>%
  count(followers) # Do houses sold fast have many followers?

ggplot(data2017, aes(x=DOM,y=followers))+ # overall number of followers vs. DOM
  geom_col(fill="lightblue")
```


### 3.2.2

```{r}


```



### 3.2.3 price vs. construction time


### 3.2.4 construction time vs. district

From the distribution of time of construction by district, we see that most of the listings were constructed in ChaoYang after the year 2000.

``` {r}
ggplot(data2017, aes(x = constructionTime)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Distribution of Time of Construction by District") +
  xlab("Time of Construction") +
  ylab("Count") +
  facet_wrap(~ district)
```

### 3.2.5 renovationCondition vs. district

From the distribution of renovation condition by district, we see that the highest number of renovation conditions with ratings 1 to 4 come from the district of ChaoYang and the lowest number of renovation conditions with ratings 1 to 4 come from the district of MenTouGou. For all districts with the exception of XiCheng, most of the listings reflect that their renovation condition is rated as 4. 

``` {r}
ggplot(data2017, aes(x = renovationCondition)) +
  geom_bar(fill = "lightblue") +
  ggtitle("Distribution of Renovation Condition by District") +
  xlab("Renovation Condition") +
  ylab("Count") +
  facet_wrap(~ district)
```


### 3.2.6 district vs. square

*Districts that have most large & small houses sold*

(ChaoYang(7) has significantly highest amount of these. But one surprising observation is that ChangPing(6) has the second highest amounts of houses in the higher 2.5%. ChangPing indeed has a relative large area compared with other districts in Beijing but it is relative far from the core area of the city. Thus, it is reasonable to have great proportion of houses sold with large square meters with lower than average square meters price.)

As indicated under the 'square' variable, the top 2.5% of houses sold have area over 150 square meters. Let's define them as "large houses". Then ChaoYang has the significantly highest amounts of large houses. ChangPing has the second highest amounts.
The bottom 2.5% of houses sold have less than 37 square meters. Let's define them as "small houses". Surprisingly, ChangPing also has the greatest amounts of small houses sold in 2017. And then second one is ChaoYang. 
Is this just because these 2 districts have the most houses sold?
Let's compare the total amounts of houses sold in ChaoYang and ChangPing.
Let's then compare the total areas of ChaoYang and ChangPing.

```{r}
data2017 %>%
  filter(square>=150) %>% # number of large houses in each district 
  count(district) %>%
  arrange(desc(n))

data2017 %>%
  filter(square<=38.6) %>% # number of small houses in each district
  count(district) %>%
  arrange(desc(n))
  

# large houses / total houses sold in a district

```


```{r}

#/table(data2017$district)



```





### 3.2.6 elevator vs. building structure

From the distribution of presence of elevator by building structure, we see that the greatest number of listings with the availability of an elevator are those that have a building structure of steel-concrete composite. For the greatest number of listings with the absence of an elevator, those would have a building structure of a mix of more than 3 distinguishable materials.

``` {r}
ggplot(data2017, aes(x = elevator, fill = elevator)) +
  geom_bar(colour = "black") +
  ggtitle("Distribution of Elevator by Building Structure") +
  xlab("Building Structure") +
  ylab("Count") +
  facet_wrap(~ buildingStructure)
```

### 3.2.7 five years property vs. district

From the distribution of five years property by district, we see that the district of ChaoYang has the highest number of previous owners who stayed in their property for more than 5 years followed by ChangPing. On the other hand, ChaoYang also has the highest number of previous owners who stayed in their property for less than 5 years followed by ChangPing. This is because ChaoYang is the largest district compared to the others and thus in terms of the total number of people staying more than or less than 5 years in that district will be the highest overall.

``` {r}
ggplot(data2017, aes(x = fiveYearsProperty, fill = fiveYearsProperty)) +
  geom_bar(colour = "black") +
  ggtitle("Distribution of Five Years Property by District") +
  xlab("Five Years Property") +
  ylab("Count") +
  facet_wrap(~ district)
```


### 3.2.8 district vs. price

#### 3.2.8.1 DongCheng vs. XiCheng (Yellow areas)

*DongCheng and XiCheng are the most center of Beijing. What affects the difference of DongCheng and XiCheng in house prices?*
The lowest price in XiCheng is almost the half of the lowest price in DongCheng, but starting from the 2.5%, the price in XiCheng jumps around 53,000 yuan more and becomes higher than DongCheng in every interval. But when comes to the highest prices, they are almost the same. This shows us that XiCheng has a wider range of house prices than DongCheng. 
DongCheng has 41.84 square km and XiCheng has 50.7 square km. XiCheng is indeed greater than DongCheng in areas and might have more houses on market, but it is not sufficient to explain XiCheng has 2 times more houses sold in 2017 than DongCheng.

```{r}

  data2017 %>%
  filter(district %in% c("DongCheng","XiCheng")) %>%
  

  
```

```{r}
data2017 %>%
  filter(district %in% c("DongCheng","XiCheng")) %>% 
  count(district) # total number of houses sold in D and X

DongCheng <-
  data2017 %>%
  filter(district=="DongCheng") 
mean(DongCheng$price)
quantile(DongCheng$price, c(0,0.025,0.25,0.5,0.75,0.975,1))

XiCheng <-
  data2017 %>%
  filter(district=="XiCheng")
mean(XiCheng$price)
quantile(XiCheng$price, c(0,0.025,0.25,0.5,0.75,0.975,1))
```


### 3.2.9 Price vs Ladder Ratio and Floor Range
```{r}
ggplot(data2017, aes(x = totalFloor, y = price, color = floorRange)) + 
  geom_point()+
  labs(x = "total number of floors", title = "Price vs Total Floor and Floor Range")
```

The floor range did not make a huge influence on the price of the house. However, the price drops significantly to 50,000 Yuan or below if the total floor is above 30, with one exception, which is the property that has 63 floors. In general, the price per square meter is lower for properties located in buildings higher than 30 floors. 

### 3.2.10 Price vs Followers
We would expect the price to be lower if there were many followers on a property because people like to keep an eye on things that are cheaper. 

```{r}
ggplot(data2017, aes(x=followers, y=price))+ geom_point() + geom_smooth() +
  labs(title = "Price vs Followers")
```

The above graph does show the negative trend between price and followers. As followers increase, the price of the perperty is lower, although this trend does not apply to houses with very few followers because many properties ranging from low price to high price had few followers. 





### **Work Cited**
## some online resources that I think might be helpful 
1. It mentions the price drop on beijing houses in 2017 because of some regulations
  http://www.xinhuanet.com/english/2018-01/29/c_136933533.htm






# 4 Model 
## 4.1 Split data into train and test
```{r}
set.seed(428)
index <- sample(nrow(data2017),21002,replace = FALSE)
train <- data2017[index,c(2,3,5:22)] # exclude total price 
test <- data2017[-index,c(2,3,5:22)] # exclude total price
```
I splited the data in half, into train and test data. Train data is used to train the model, while test data is used to test the accuracy of prediction from the model. 

## 4.2 Linear Model (Validation set approach)
```{r}
linear_model <- lm(price~., data = train)
summary(linear_model)
```
In this model, I randomly split data into training set and testing set, which is the validation set approach. Based on the results of linear model, all the variables are important except for five year property and the day of month being sold.

```{r}
# training MSE
pred_train_lm <- predict(linear_model, train, type="response")
mean((pred_train_lm-train$price)^2)
# testing MSE
pred_test_lm <- predict(linear_model, test, type="response")
mean((pred_test_lm-test$price)^2)
```
After putting test data into linear model, the mean squared error for both test data and train data look pretty big. Let's look at if k-fold cross validation could produce a better MSE. 


## 4.3 Linear Model (k-fold cross validation, k=10)
```{r}
library(caret)
set.seed(428) 
train.kfold <- trainControl(method = "cv", number = 10)
# Train the model
kfold_model <- train(price ~., data = data2017[,c(2,3,5:22)], method = "lm",
               trControl = train.kfold)
(kfold_model$resample$RMSE)^2
```

The above list of number shows the MSE for each fold. Comparing the MSE of k-fold cross validation with MSE of validation set approach, performing k-fold cross validation did not improve much on MSE. 


## 4.4 Backward Regression
```{r}
library(leaps)
backward <- regsubsets(price~.,data=train,method="backward")
summary(backward)
plot(backward,scale="bic", cex.names= 0.5)
```
Based on the plot and model summary, the best backward regression model includes followers, square, subway, district ChaoYang, district DongCheng, district FengTai, district HaiDian, district Xicheng (all important districts are the core districts). Lets put these important variables in linear model. 

```{r}
backward_model <- lm(price~followers+square+subway+district, data = train)
summary(backward_model)
# training MSE
pred_train_lm <- predict(linear_model, train, type="response")
mean((pred_train_lm-train$price)^2)
# testing MSE
pred_test_lm <- predict(linear_model, test, type="response")
mean((pred_test_lm-test$price)^2)
```

Since the resulting backward model MSE for both training and testing data are very close to the MSE of linear regression using all variables, we can choose to use the simpler model with followers, square, subway, and district as the predictors. 

Coefficient interpretation:
- if followers increase by 1, the average price decreases by 39.87
- if square increases by 1, the average price decreases by 58.39
- if there is a subway near the house, we would expect the price to be 5667 Yuan higher than houses without a subway.
- Being in ChaoYang, DongCheng, FengTai, HaiDian, ShiJingShan, and XiCheng increases the price with a significant amount compared to ChangPing because these are all core districts that are located in the center of Beijing.
- Being in FangShan and ShunYi significantly decreases the price compared to ChangPing because these are the rural districts. 
- Being in DaXing and TongZhou increases the price in a small amount compared to ChangPing because these two rural areas are developing, but not as developed as core districts. (A few tech companies moved to DaXing and Beijing plans to develop TongZhou as its sub-center.)
- The price in MenTouGou is not significantly different from price in ChangPing since these two are both rural districts. 




## 4.5 Random Forest
```{r}
library(randomForest)
set.seed(428)
rf_model <- randomForest(price~.,data=train,mtry=6,importance=TRUE)
varImpPlot(rf_model)
```

Since we are using MSE to evaluate the models, we will look at the plot on the left. The plot shows that district contributes most in reducing MSE in the model, with subway, construction time, square, followers, etc in decreasing order. 


```{r}
# training MSE
pred_train_rf <- predict(rf_model, train, type="response")
mean((pred_train_rf-train$price)^2)
# testing MSE
pred_test_rf <- predict(rf_model, test, type="response")
mean((pred_test_rf-test$price)^2)
```

Random Forest significantly reduced the MSE for both prediction of training and testing dataset. The MSE for testing dataset is much larger than training dataset because of overfitting effect, but it's still better than linear models. Because we have a smaller MSE, random forest is so far the best model in predicting house price per square meter, with district, subway, contruction time, square as some of the most important predictor. 
