---
title: "Stats 15 Project"
author: "Team 13: Wanyue Dong, Michelle Pang, Liaohan Wang"
date: "10/31/2022"
output: pdf_document
---

# Section 1: Introduction

Districts: 
1-DongCheng
2-FengTai
3-YiZhuang
4-DaXing
5-FangShan
6-ChangPing
7-ChaoYang
8-HaiDian 
9-ShiJingShan
10-XiCheng
11-TongZhou
12-MenTouGou
13-ShunYi


# Section 2: Data Cleaning
```{r, message=FALSE, warning=FALSE}
# loading libraries
library(lubridate)
library(dplyr)
library(VIM)
library(stringr)
library(ggplot2)
```

```{r}
# the following code is used to import dataset that includes Chinese character
data <- read.csv("new.csv", fileEncoding = "GBK", encoding = "GBK")
```


## 2.1 Cleaning Trade Time Variable
The `r tradeTime` variable is in the format of y-m-d, we wanted to look at year, month, and day separately. Therefore, we created new variables `r year`, `r month`, `r day` based on `r tradeTime`. \newline
Since the current data has 318851 rows, we decided to use part of the data where the trade time was in 2017.

```{r, message=FALSE, warning=FALSE}
data2017 <- data %>% 
  mutate(year = year(tradeTime), month = month.name[month(tradeTime)], day = day(tradeTime)) %>%
  filter(year == 2017)
```


## 2.2 Cleaning Floor Variable 

```{r}
data2017 %>% select(floor) %>% head(3)
```

The `r floor` variable two piece of information. The first part, which is in Chinese character, informs the floor range of the apartment/house. The second part, which is a number, tells us the total number of floors the building has. Therefore, we need to separate these two information into two new variables (` r totalFloor` and `r floorRange`) to better analyze them. At the same time, we converted Chinese characters into English. 

```{r}
data2017 <- data2017 %>% 
  mutate(totalFloor = as.numeric(str_extract(floor, "(\\d)+")), 
         floorRange = case_when(str_detect(floor, "顶") ~ "top", 
                                str_detect(floor, "高") ~ "high", 
                                str_detect(floor, "中") ~ "midium",
                                str_detect(floor, "低") ~ "low",
                                str_detect(floor, "底") ~ "bottom"))

```



## 2.3 Missing Values
```{r, message=FALSE, warning=FALSE}
table(is.na(data2017))
na_plot <- aggr(data2017, col=c('skyblue','red'), numbers=TRUE, sortVars=TRUE, 
                labels=names(data2017), cex.axis=.4, gap=3, ylab=c("Missing data","Pattern"))
```

Our data had 507 missing values. All missing values are in variables building type and community average, and mostly in building type. The above graph shows the proportion of missing values in each variable with the highest being 0.011 for buildingType. \newline
We decided to remove all missing values for two reasons. First, 507 missing values is a relatively small amount of data compared to 43217 observations we have. Second, we did not plan to use the variable buildingType, which had the most missing values. 

```{r}
data2017 <- na.omit(data2017)
```

Now we have 42710 observations.

## 2.4 Remove unnecessary variables

The final step of data cleaning is removing variables that we do not plan to use. 
```{r}
data2017 <- data2017 %>%
  select(-c(url, Lng, Lat, Cid, tradeTime, floor, buildingType, communityAverage))
```




# Section 3: Exploratory Analysis

## 3.1 Distribution of variables and outliers

### 3.1.1 Price
```{r}
summary(data2017$price)
```

```{r}
data2017 <- data2017 %>% 
  filter(price>1000)
```

### 3.1.2 Square

A house with more 1745.5 square meter seems very unreasonable, so we decided houses that are less than 1000 square meters are plausible. 
```{r}
data2017 <- data2017 %>% 
  filter(square < 1000)
```

### 3.1.3 Kitchen

```{r}
data2017 %>% 
  filter(kitchen>2) 
```

There are two houses with more than 2 kitchens, which seem odd. Taking a closer look, both of these houses had less than 300 square meters, which is impossible to have 3 kitchens in fairly medium house size. Therefore, we removed these two outliers. 

```{r}
data2017 <- data2017 %>%
  filter(kitchen < 3)
```


### Ladder Ratio
```{r}
data2017 <- data2017 %>% 
  filter(ladderRatio < 5)
```


### Month
```{r}
ggplot(data2017, aes(x = month)) + 
  geom_bar(fill = "light blue") + 
  scale_x_discrete(limits = month.name)
```

The first three months of year 2017 had the most trading of houses, with March being the highest number of trading. 


### Day
```{r}
ggplot(data2017, aes(x = day)) + 
  geom_bar(fill = "purple")
```

There isn't a unique day of the month that people liked to buy houses, but people relatively like to buy houses in the middle of the month. Few trades happened in the beginning of the month. 

### Total Floor
```{r}
ggplot(data2017, aes(x = totalFloor)) + geom_histogram(color = "black", fill = "blue") 
summary(data2017$totalFloor)

data2017 %>% arrange(desc(totalFloor)) %>% select(id, totalFloor, floorRange) %>% head()
data2017 <- data2017 %>%
  filter(totalFloor < 60)
```
The distribution of total floor is skewed to the right. There are quite a few very tall buildings, but such high numbers could be an error in data recording. The url for the apartment located in a building with 63 floors is invalid; however, we checked the apartment located in the building with 57 floors using url and, surprisingly, the building does exist and is called Yu Jin Tai. Therefore, we only removed the trade with total floor of 63. 


### Floor Range
```{r}
ggplot(data2017, aes(x = floorRange)) + 
  geom_bar(fill = "green") +
  scale_x_discrete(limits = c("bottom", "low", "midium", "high", "top")) 
```
Apartments located in the middle of a building were traded the most in 2017. 


## DOM

The graph of number of days on market is heavily skewed to the right. 

```{r DOM}
library(ggplot2)
ggplot(data2017, aes(x=DOM))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("DOM")+ylab("Count")+ggtitle("Active Days on Market Histogram")
```

## followers

This graph heavily skewed to the right. More than 97% of houses have less than 300 followers. Most houses have number of followers below 300. There are 5617 houses with 0 follower. There are also a total of 5 houses with more than 1000 followers. Among them, there is 1 house has significant low total price compare with other houses. However, it also has relative small area and is located in the suburb, which makes this reasonable. 

```{r followers}
library(ggplot2)
ggplot(data2017, aes(x=followers))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("followers")+ylab("Count")+
  ggtitle("followers Histogram")
```

```{r followers}
data2017 %>% 
  select(id,followers,totalPrice,price,square,district) %>%
  slice_max(followers,n=10) 

data2017 %>% 
  filter(followers==0) %>%
  select(id,followers,totalPrice,price,square,district) 

lessthan300 <- data2017 %>%
  filter(followers<=300)
nrow(lessthan300)

portion_lessthan300 = nrow(lessthan300)/43217
portion_lessthan300
```


## totalPrice

This graph skews to the right.

```{r totalPrice}
library(ggplot2)
ggplot(data2017, aes(x=totalPrice))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("totalPrice")+ylab("Count")+ggtitle("Total price (in 10,000yuan) Histogram")
```

## price



```{r}
library(ggplot2)
ggplot(data2017, aes(x=price))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("price")+ylab("Count")+ggtitle("Average price per square (in yuan) Histogram")
```


## square

This graph skews to the right.

```{r square}
library(ggplot2)
ggplot(data2017, aes(x=square))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("square")+ylab("Count")+ggtitle("square of the House Histogram") 
```

## livingRoom

One thing need to be noticed is that in this dataset, the variable 'livingRoom' could be understand as 'bedrooms' in the US. Most of the houses have 2 living rooms.

```{r livingRoom}
library(ggplot2)
ggplot(data2017, aes(x=livingRoom))+
  geom_bar(fill='lightblue', color='black') + # use geom_bar() instead of geom_histogram()
  xlab("livingRoom")+ylab("Count")+ggtitle("Number of Living room Histogram")

# 1 house with 0 living room
livingRoom0 <- data2017 %>%
  filter(livingRoom==0)
nrow(livingRoom0)
#

```

## drawingRoom

The number of drawing rooms for all houses is between 0 to 4. Most houses sold in 2017 have 0 to 2 drawing rooms and nearly 78% of houses sold in 2017 have 1 drawing room. Houses with 0 drawing room is the third greatest choice, and it is reasonable for a house to have no drawing room, especially in the city.

```{r drawingRoom}
library(ggplot2)
ggplot(data2017, aes(x=drawingRoom))+
  geom_bar(fill='lightblue', color='black') + # use geom_bar() instead of geom_histogram()
  # scale_y_continuous(trans="log10") +
  xlab("drawingRoom")+
  ylab("Count")+
  ggtitle("Number of Drawing Rooms Histogram")
```

```{r drawingRoom}
drawingRoom1 <- data2017 %>%
  filter(drawingRoom==1) %>%
  nrow()
portion_dr1 = drawingRoom1 / 43217
portion_dr1
```

## district (Categorical Variable)
I want to change the numbers into district names on the axis

```{r district}
library(ggplot2)
ggplot(data2017, aes(x=district))+
  geom_bar(fill='lightblue', color='black') +
  xlab("district")+
    ylab("Count")+
  ggtitle("District the House located Histogram") 

# display all x labels
#district_text <- c("DongCheng", "FengTai", "YiZhuang", "DaXing", "FangShan", "ChangPing", "ChaoYang", "HaiDian" , "ShiJingShan", "XiCheng", "TongZhou", "MenTouGou", "ShunYi")
```




