---
title: "Stats 15 Project"
author: "Team 13: Wanyue Dong, Michelle Pang, Liaohan Wang"
date: "10/31/2022"
output: pdf_document
---


# **Section 1 - Introduction**

## **1.1 - Motivating Questions and Scope of Analysis**

As one of the biggest cities in China, Beijing currently houses a population of 21.33 million residents. With the rapid rate of globalization, the movement of people selling and buying their property has risen as well. However, with the help of Lianjia, buyers and sellers are able to view and list properties with ease. In this project, we seek to answer the following motivating question: **what affects the price per square foot of a property?**

## **1.2 - Background on Lianjia**

***Basic Structure:*** Lianjia is a Chinese real-estate company that allows buyers and sellers to view and list properties all over China on the Lianjia website. In our data set, we narrowed down our listings to those that were traded in 2017. This means that any property that was listed or sold in 2017 will be included and the others will be excluded. We found our data set on a website called Kaggle which is a data science company which provides a variety of public data sets. Before cleaning the data, our data set had 318,815 listings and 26 variables.

***How a Seller can Post a Listing:*** To post a listing on Lianjia, the owner or the real estate agent of the property will have to follow the guidelines and steps provided by filling out the necessary information regarding the property such as price of listing, number of bathrooms, square footage of the entire property and more listed below in the explanatory variables. They will also need to provide accompanying photographs of the property.

***How a Buyer can Purchase a Listing:*** To purchase a listing on Lianjia, the buyer can simply just reach out to the contact number or email of the real estate angent provided to arrange a viewing. After viewing the property and possible negotiations, both parties will agree on a price for the transaction and legal paperwork will be organized by the real estate agency to facilitate the payment process and finally legalize the change of ownership of the property.

***Beijing Districts:*** There are a total of 13 districts within Beijing that we will be focusing on. These 13 districts include DongCheng, FengTai, YiZhuang, DaXing, FangShan, ChangPing, ChaoYang, HaiDian, ShiJingShan, XiCheng, TongZhou, MenTouGou and ShunYi. Each listing in our data set lies in one of these 13 districts.

## **1.3 - Variable Explanation**

### **Explanatory Variables**

1. ***DOM***: (*numerical*) The active days on market. The number of days since the property is posted until it is sold and removed from the website. 
2. ***followers***: (*numerical*) The number of people who follow the transaction by bookmarking the property to revisit later on. This indicates the popularity of a property compared to the other listings.
3. ***livingRoom***: (*numerical*) The number of bedrooms.
4. ***drawingRoom***: (*numerical*) The number of living rooms.
5. ***kitchen***: (*numerical*) The number of kitchens.
6. ***bathRoom***: (*numerical*) The number of bathrooms.
7. ***floor***: (*numerical*) The total number of floors the building has. This usually also refers to the height of the building.
8. ***constructionTime***: (*categorical*) The year the building was constructed.
9. ***renovationCondition***: (*categorical*) The quality of the renovation with 4 being the best and 1 being the worst.
10. ***buildingStructure***: (*categorical*) The material that is used the most to construct the building. More specifically, the main material used to build the exterior of the building. In this case, 1 refers to the material being unknown, 2 refers to the material being a mix of more than 3 distinguishable materials, 3 refers to brick and wood, 4 refers to brick and concrete, 5 refers to steel and 6 refers to steel-concrete composite. 
11. ***ladderRatio***: (*categorical*) The proportion between number of residents who live on the same floor to the number of elevators or ladders that particular floor has. It relates to the frequency of usage of the elevator per floor. In this case, 1.00 refers to the highest frequency of usage and 0.00 refers to lowest frequency of usage.
12. ***elevator***: (*categorical*) The presence of an elevator or not. In this case, 1 refers to the presence of an elevator in the building and 0 refers to the absence of an elevator in the building.
13. ***fiveYearsProperty***: (*categorical*) Refers to whether or not the previous owner has owned the property for less than five years. In this case, 1 refers to the property being owned by the previous owner for less than five years and 0 refers to the property being owned by the previous owner for more than five years. 
14. ***subway***: (*categorical*) Based on the knowledge of the seller posting the listing, this variable shows if a subway is located near the property. In this case, 1 refers to the presence of a subway nearby and 0 refers to the absence of a subway nearby.

```{r pressure, echo=FALSE, fig.cap="Beijing District Map", out.width = '50%'}
knitr::include_graphics("beijing_map.jpeg")
```

15. ***district***: (*categorical*) There are 13 main districts in Beijing and each number from 1 to 13 refers to a different district in which the property lies in. In this case, 1 refers to DongCheng, 2 refers to FengTai, 3 refers to YiZhuang, 4 refers to DaXing, 5 refers to FangShan, 6 refers to ChangPing, 7 refers to ChaoYang, 8 refers to HaiDian, 9 refers to ShiJingShan, 10 refers to XiCheng, 11 refers to TongZhou, 12 refers to MenTouGou and 13 refers to ShunYi.

### **Response Variable**
1. ***price***: (*integer*) The price per square foot of the property (price = totalPrice / square). To ensure that the price is a fair comparison across all the properties listed, we decided to compare the price per square foot of all properties instead of totalPrice. Since some properties may be bigger than others, comparing price per square foot provides us with a better understanding of how valuable a property is.


Districts: 
1-DongCheng
2-FengTai
3-YiZhuang
4-DaXing
5-FangShan
6-ChangPing
7-ChaoYang
8-HaiDian 
9-ShiJingShan
10-XiCheng
11-TongZhou
12-MenTouGou
13-ShunYi


# Section 2: Data Cleaning
```{r, message=FALSE, warning=FALSE}
# loading libraries
library(lubridate)
library(dplyr)
library(VIM)
library(stringr)
library(ggplot2)
library(naniar)
```

```{r}
# the following code is used to import dataset that includes Chinese character
data <- read.csv("new.csv", fileEncoding = "GBK", encoding = "GBK")
```


## 2.1 Cleaning Trade Time Variable
The `tradeTime` variable is in the format of y-m-d, we wanted to look at year, month, and day separately. Therefore, we created new variables `year`, `month`, `day` based on `tradeTime`. \newline
Since the current data has 318851 rows, we decided to use part of the data where the trade time was in 2017.

```{r, message=FALSE, warning=FALSE}
data2017 <- data %>% 
  mutate(year = year(tradeTime), month = month.name[month(tradeTime)], day = day(tradeTime)) %>%
  filter(year == 2017)
```


## 2.2 Cleaning Floor Variable 

The `floor` variable two piece of information. The first part, which is in Chinese character, informs the floor range of the apartment/house. The second part, which is a number, tells us the total number of floors the building has. Therefore, we need to separate these two information into two new variables (` totalFloor` and `floorRange`) to better analyze them. At the same time, we converted Chinese characters into English. 

```{r, echo=FALSE}
data2017 <- data2017 %>% 
  mutate(totalFloor = as.numeric(str_extract(floor, "(\\d)+")), 
         floorRange = case_when(str_detect(floor, "顶") ~ "top", 
                                str_detect(floor, "高") ~ "high", 
                                str_detect(floor, "中") ~ "midium",
                                str_detect(floor, "低") ~ "low",
                                str_detect(floor, "底") ~ "bottom"))

```

## 2.3 Cleaning variable format

Some variables such as living room and bedroom  should be numerical variable, while other variables such as subway and elevator should be categorical variables. We also recoded the district variable into district names, which will be easier to see for later analysis. Finally, the living room in this dataset should be bedroom and drawing room in this dataset should be living room. 
```{r, warning=FALSE, message=FALSE}

data2017 <- data2017 %>% 
  rename(livingRoom = drawingRoom, bedRoom = livingRoom) %>%
  mutate(constructionTime = as.numeric(constructionTime), 
         livingRoom = as.numeric(livingRoom),
         bedRoom = as.numeric(bedRoom),
         bathRoom = as.numeric(bathRoom),
         kitchen = as.numeric(kitchen),
         subway = as.factor(subway),
         elevator = as.factor(elevator),
         fiveYearsProperty = as.factor(fiveYearsProperty),
         district = recode(district, "1" = "DongCheng",
                           "2" = "FengTai", "3" = "YiZhuang", "4" = "DaXing", 
                           "5" = "FangShan", "6" = "ChangPing", "7" = "ChaoYang",
                           "8" = "HaiDian", "9" = "ShiJingShan", "10" = "XiCheng", 
                           "11" = "TongZhou", "12" = "MenTouGou", "13" = "ShunYi"))
```




## 2.4 Missing Values

```{r, message=FALSE, warning=FALSE}
table(is.na(data2017))
na_plot <- aggr(data2017, col=c('skyblue','red'), numbers=TRUE, sortVars=TRUE, 
                labels=names(data2017), cex.axis=.4, gap=3, ylab=c("Missing data","Pattern"))
```

Our data had 1303 missing values. All missing values are in variables construction time, building type, community average, and floor range. The above graph shows the proportion of missing values in each variable with the highest being 0.018 for construction time. \newline
We decided to remove all missing values for two reasons. First, 1303 missing values is a relatively small amount of data compared to 43217 observations we have. Second, we did not plan to use the variable buildingType and community average, which had a large portion of missing values. 

```{r}
data2017 <- na.omit(data2017)
```

Now we have 42710 observations.

## 2.5 Remove unnecessary variables

The final step of data cleaning is removing variables that we do not plan to use. 
```{r}
data2017 <- data2017 %>%
  select(-c(url, Lng, Lat, Cid, tradeTime, floor, buildingType, communityAverage, year))
```




# Section 3: Exploratory Analysis

## 3.1 Distribution of variables and outliers

### 3.1.1 Month
```{r}
ggplot(data2017, aes(x = month)) + 
  geom_bar(fill = "light blue") + 
  scale_x_discrete(limits = month.name)
```

The first three months of year 2017 had the most trading of houses, with March being the highest number of trading, more than 8000 tradings. Apirl, May, and June each only had less than 1/4 of the number of trading compared to March. The amount of transactions for the rest of the year remained below 4000. 


### 3.1.2 Day
```{r}
ggplot(data2017, aes(x = day)) + 
  geom_bar(fill = "light blue", color = "black")
```
There isn't a unique day of the month that people liked to buy houses, but people relatively like to buy houses in the middle of the month. Few trades happened in the beginning of the month. 

### 3.1.3 Total Floor
```{r}
ggplot(data2017, aes(x = totalFloor)) + geom_histogram(color = "black", fill = "blue") 
summary(data2017$totalFloor)

data2017 %>% arrange(desc(totalFloor)) %>% select(id, totalFloor, floorRange) %>% head()
data2017 <- data2017 %>%
  filter(totalFloor < 60)
```
The distribution of total floor is unimodel and skewed to the right. There are quite a few very tall buildings, but such high numbers could be an error in data recording. The url for the apartment located in a building with 63 floors is invalid; however, we checked the apartment located in the building with 57 floors using url and, surprisingly, the building does exist and is called Yu Jin Tai. Therefore, we only removed the trade with total floor of 63. 


### 3.1.4 Floor Range
```{r}
ggplot(data2017, aes(x = floorRange)) + 
  geom_bar(fill = "light blue") +
  scale_x_discrete(limits = c("bottom", "low", "midium", "high", "top")) 
```
Apartments located in the middle of a building were traded the most in 2017. 


### 3.1.5 DOM

The graph of number of days on market is unimodal and heavily skewed to the right. The mean number of days on market is around 51 and the median is 31 days. Approximately 2.5% of values are below 2. Approximately 2.5% of values are above 196. The longest day on market is 721. Whereas there are total of 474 houses have less or equal to 1 day on market until sold. A great portion of these houses are sold in March, which is the peak of house transaction in Beijing in 2017 as the previous 'month' variable section showed. And most of these houses are located in ChaoYang(7) district. According to the following 'district' variable section showed, ChaoYang indeed is the district that has the most transactions. The number of followers of these houses is between 0 to 9, which is not a great number. And nearly half of these houses have no followers. It shows that the number of followers is not necessarily indicating the "popularity" of the houses.

```{r}
ggplot(data2017, aes(x=DOM))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("DOM")+ylab("Count")+ggtitle("Active Days on Market Histogram")

mean(data2017$DOM)
median(data2017$DOM)
quantile(data2017$DOM, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

data2017 %>%
  filter(DOM<=1) %>%
  nrow()  # number of houses have less than 1 day on market

data2017 %>%
  filter(DOM<=1) %>%
  count(month) # In which months are these houses sold

data2017 %>%
  filter(DOM<=1) %>%
  count(district) # In which districts are these houses sold

data2017 %>%
  filter(DOM<=1) %>%
  count(followers) # Do houses sold fast have many followers?
```

### 3.1.6 followers

The graph of number of followers is unimodal and heavily skewed to the right. The mean and median number of followers is the same, which is around 49 people. Approximately 2.5% of values are below or equal to 0. Approximately 2.5% of values are above 216. More than 97% of houses have less than 300 followers. There are 5617 houses with 0 follower. There are also a total of 5 houses with more than 1000 followers. Among these houses with more than 1000 followers, there is 1 house has significant low total price compare with other houses. However, it also has relative small area and is located in the suburb, which makes this reasonable. 

```{r}
ggplot(data2017, aes(x=followers))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("followers")+ylab("Count")+
  ggtitle("followers Histogram")

mean(data2017$followers)
mean(data2017$followers)
quantile(data2017$followers, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))
```

```{r}
data2017 %>% 
  select(id,followers,totalPrice,price,square,district) %>%
  slice_max(followers,n=10) 

lessthan300 <- data2017 %>%
  filter(followers<=300)
nrow(lessthan300)

portion_lessthan300 = nrow(lessthan300)/42004
portion_lessthan300
```


### 3.1.7 totalPrice
## problem: some districts do not have high or low 2.5% houses and are not shown on the tibbles. So the numbers do not match. Replace missing values with 0?

The graph of total price is diamond-shaped, unimodal, and skews right. The average total price of a house in Beijing in 2017 is 526x10,000 yuan (around 750~810 thousands dollars depend on inflation) and the median is 460x10,000 yuan (around 660~710 thousands dollars). 
Approximately 2.5% of values are below 215x10,000 yuan. Among these houses, ChangPing(6) has significantly higher amounts of these. ChangPing is the northern suburb of Beijing. And the second one is ChaoYang(7).
Approximately  2.5% of values are above 1250x10,000 yuan. Among these houses, ChangPing(6) has none of these whereas ChaoYang(7) has significantly highest amounts of these. It seems like ChaoYang has houses with big ranges of prices. Even though XiCheng(10) and DongCheng(1) are the most central part of Beijing and close to each other, XiCheng has 85% more higher 2.5% percentile houses sold in 2017. XiCheng spans 32 square kilometers and DongCheng spans 40.6 square kilometers. DongCheng actually has larger area than XiCheng but XiCheng has more houses sold.


```{r}
ggplot(data2017, aes(x=totalPrice))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("totalPrice")+ylab("Count")+ggtitle("Total price (in 10,000yuan) Histogram")

mean(data2017$totalPrice)
median(data2017$totalPrice)
quantile(data2017$totalPrice, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

# tried to compute percenatge of low&high 2.5% within each district to find out what affect DongCheng and XiCheng
lower2_5 <- data2017 %>%
  filter(totalPrice<=215) %>% # number of lower 2.5% houses in each district
  count(district) #%>%
  #pull()
lower2_5

higher2_5 <- data2017 %>% # number of higher 2.5% houses in each district
  filter(totalPrice>=1250) %>%
  count(district) #%>%
  #pull()
higher2_5

num_district_percentage <-district_percentage %>%
  pull()
num_district_percentage




```


### 3.1.8 price

The graph for price is Diamond-shaped, unimodal, and skewed right. The average price per square meter is around 67,430 yuan and median is 62670, which are relative close. Approximately 2.5% of values are above 127,359 yuan. Approximately 2.5% of values are below 33035 yuan. The house that has the lowest value has 136 yuan per square meter, which is about 20 dollars per square meter. Such low price doesn't make sense in any part of Beijing. Therefore, we decided to remove this outlier. 

```{r}
ggplot(data2017, aes(x=price))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("price")+ylab("Count")+ggtitle("Average price per square meter (in yuan) Histogram")

mean(data2017$price)
quantile(data2017$price, c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1))

data2017 %>%
  filter(price<=1000) 

data2017 <- data2017 %>% 
  filter(price>1000)

summary(data2017$price)
```


### 3.1.9 square

This graph skews to the right.

```{r}
ggplot(data2017, aes(x=square))+
  geom_histogram(fill='lightblue', color='black') +
  xlab("square")+ylab("Count")+ggtitle("square of the House Histogram") 
```
A house with more 1745.5 square meter seems very unreasonable, so we decided houses that are less than 1000 square meters are plausible. 
```{r}
data2017 <- data2017 %>% 
  filter(square < 1000)
```

### 3.1.10 bedRoom

One thing need to be noticed is that in this dataset, the variable 'livingRoom' could be understand as 'bedroom' in the US. Most of the houses have 2 bedrooms.

```{r}
ggplot(data2017, aes(x=bedRoom))+
  geom_bar(fill='lightblue', color='black') + # use geom_bar() instead of geom_histogram()
  xlab("bedRoom")+ylab("Count")+ggtitle("Number of bedroom Histogram")

# 1 house with 0 bed room
table(data2017$bedRoom)

```

### 3.1.11 livingRoom

The number of living rooms for all houses is between 0 to 4. Most houses sold in 2017 have 0 to 2 living rooms and nearly 78% of houses sold in 2017 have 1 living room. Houses with 0 living room is the third greatest choice, and it is reasonable for a house to have no living room, especially in the city.

```{r}
ggplot(data2017, aes(x=livingRoom))+
  geom_bar(fill='lightblue', color='black') + # use geom_bar() instead of geom_histogram()
  xlab("livingRoom")+
  ylab("Count")+
  ggtitle("Number of Living Rooms Histogram")
```

```{r}
table(data2017$livingRoom)/length(data2017$livingRoom)
```

### 3.1.12 district 

```{r}
ggplot(data2017, aes(x=district))+
  geom_bar(fill='lightblue', color='black') +
  xlab("district")+
  ylab("Count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  ggtitle("District the House located Histogram") 

district_percentage <- data2017 %>%
  group_by(district) %>%
  count(district) %>%
  mutate(percentage=n*100/42004) %>% # what percentage of sold houses are in each district
  arrange(desc(n))
district_percentage

```



summary statistics and distributional shape
- construction time
Construction time would be the year that the property is built
```{r}
table(data2017$constructionTime)

barplot(table(data2017$constructionTime))
```
- renovation condition
Renovation Condition refers to the readiness for the next property owner to move in with 4 being the most to move in and 1 being the least ready to move in
```{r}
table(data2017$renovationCondition)

barplot(table(data2017$renovationCondition))
```
- building structure
Building Structure would be the main material that the building is made out of 
```{r}
table(data2017$buildingStructure)

barplot(table(data2017$buildingStructure))
```
- ladder ratio
```{r}
table(data2017$ladderRatio)

barplot(table(data2017$ladderRatio))
```
The maximum value for ladderRatio is 10009400, which seems like a typo, so we decided to remove this observation. 
```{r}
data2017 <- data2017 %>% 
  filter(ladderRatio < 5)
```

- elevator
```{r}
table(data2017$elevator)

barplot(table(data2017$elevator))
```
- five years property
```{r}
table(data2017$fiveYearsProperty)

barplot(table(data2017$fiveYearsProperty))
```
- subway
```{r}
table(data2017$subway)

barplot(table(data2017$subway))
```
- kitchen
Kitchen would be the number of kitchens the property has, with 1 kitchen being the most popular
```{r}
table(data2017$kitchen)

barplot(table(data2017$kitchen))
```

```{r}
data2017 %>% 
  filter(kitchen>2) 
```

There are two houses with more than 2 kitchens, which seem odd. Taking a closer look, both of these houses had less than 300 square meters, which is impossible to have 3 kitchens in fairly medium house size. Therefore, we removed these two outliers. 

```{r}
data2017 <- data2017 %>%
  filter(kitchen < 3)
```

- bathroom
Bathroom would be the number of bathrooms the property has, with 1 bathroom being the most popular
```{r}
table(data2017$bathRoom)

barplot(table(data2017$bathRoom))
```

potential relationships that may exist in the data
- construction time, renovation condition
```{r}

```

- construction time, building structure
```{r}

```

<<<<<<< Updated upstream
=======
## **Section 1 - Introduction**
### **1.1 - Motivating Questions and Scope of Analysis**
As one of the biggest cities in China, Beijing currently houses a population of 21.33 million residents. With the rapid rate of globalization, the movement of people selling and buying their property has risen as well. However, with the help of Lianjia, buyers and sellers are able to view and list properties with ease. In this project, we seek to answer the following motivating question: **what affects the price per square foot of a property?**

### **1.2 - Background on Lianjia**
***Basic Structure:*** Lianjia is a Chinese real-estate company that allows buyers and sellers to view and list their properties all over China. In our data set, we narrowed down our listings to those that were traded in 2017, meaning that any property that was listed or marked as sold in 2017 will be included. We found our data set on Kaggle which is a dataset company 


### **Work Cited**
## some online resources that I think might be helpful 
1. It mentions the price drop on beijing houses in 2017 because of some regulations
  http://www.xinhuanet.com/english/2018-01/29/c_136933533.htm
>>>>>>> Stashed changes





# 4 Model 
## 4.1 Split data into train and test
```{r}
set.seed(428)
index <- sample(nrow(data2017),21002,replace = FALSE)
train <- data2017[index,c(2,3,5:22)] # exclude total price 
test <- data2017[-index,c(2,3,5:22)] # exclude total price
```
I splited the data in half, into train and test data. Train data is used to train the model, while test data is used to test the accuracy of prediction from the model. 

## 4.2 Linear Model
```{r}
linear_model <- lm(price~., data = train)
summary(linear_model)
```
Based on the results of linear model, all the variables are important except for five year property and the day of month being sold.

```{r}
# training MSE
pred_train_lm <- predict(linear_model, train, type="response")
mean((pred_train_lm-train$price)^2)
# testing MSE
pred_test_lm <- predict(linear_model, test, type="response")
mean((pred_test_lm-test$price)^2)
```
For now, the MSE looks pretty big. Let's take a look at other models. 


## 4.2 Random Forest





